<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centra Plate - Real-time Chat Test</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f0f2f5; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .config { background: #e9ecef; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .chat-box { height: 400px; overflow-y: scroll; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 6px; background: #fff; }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 70%; clear: both; }
        .sent { background: #0084ff; color: white; float: right; }
        .received { background: #e4e6eb; color: black; float: left; }
        .control-panel { display: flex; gap: 10px; }
        input, button { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        input { flex: 1; }
        button { background: #0084ff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #0073e6; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        .status { margin-left: 10px; font-weight: bold; }
        .status.connected { color: green; }
        .status.disconnected { color: red; }
    </style>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>ðŸš— Centra Plate Real-Time Test</h2>
        
        <!-- Login / Identify Section -->
        <div class="config" id="loginSection">
            <label>Step 1: Identify Yourself</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="myUserId" placeholder="Your User ID (e.g., 1)" />
                <button onclick="connectAndIdentify()">Connect</button>
            </div>
        </div>

        <!-- Connection Status -->
        <div id="statusArea" style="margin-bottom: 10px; display:none;">
            Status: <span id="connectionStatus" class="status disconnected">Disconnected</span>
            (Logged in as User ID: <span id="displayUserId"></span>)
        </div>

        <!-- Chat Area -->
        <div id="chatSection" style="opacity: 0.5; pointer-events: none;">
            <div class="chat-box" id="messagesList">
                <!-- Messages will appear here -->
                <div style="text-align:center; color:#888; margin-top:180px;">Connect to start chatting</div>
            </div>

            <label>Send Message</label>
            <div class="control-panel" style="margin-bottom: 10px;">
                <input type="number" id="receiverId" placeholder="Receiver ID (e.g., 2)" />
                <input type="text" id="receiverPlate" placeholder="OR Plate Number (e.g., ABC-123)" />
            </div>
            <div class="control-panel">
                <input type="text" id="messageInput" placeholder="Type a message..." />
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let socket;
        let myId;
        const SERVER_URL = "http://localhost:3000";

        function connectAndIdentify() {
            const userIdInput = document.getElementById('myUserId').value;
            if (!userIdInput) return alert("Please enter a User ID");
            
            myId = parseInt(userIdInput);
            
            // Connect to Socket.io
            socket = io(SERVER_URL);

            socket.on('connect', () => {
                document.getElementById('connectionStatus').innerText = "Connected";
                document.getElementById('connectionStatus').className = "status connected";
                document.getElementById('displayUserId').innerText = myId;
                
                // Enable Chat UI
                document.getElementById('chatSection').style.opacity = "1";
                document.getElementById('chatSection').style.pointerEvents = "all";
                document.getElementById('loginSection').style.display = "none";
                document.getElementById('statusArea').style.display = "block";

                // IDENTIFY EVENT
                console.log("Emitting identify for User:", myId);
                socket.emit('identify', myId);
            });

            socket.on('disconnect', () => {
                document.getElementById('connectionStatus').innerText = "Disconnected";
                document.getElementById('connectionStatus').className = "status disconnected";
                document.getElementById('chatSection').style.opacity = "0.5";
            });

            // RECEIVE MESSAGE EVENT
            socket.on('receive_message', (data) => {
                console.log("New Message Received:", data);
                addMessageToUI(data.content, 'received', `User ${data.sender_id}`);
            });

            // MESSAGE SENT CONFIRMATION
            socket.on('message_sent', (data) => {
                console.log("Message Sent Confirmed:", data);
                addMessageToUI(data.content, 'sent', 'You');
            });
            
            // ERROR HANDLING
            socket.on('error', (err) => {
                alert("Error: " + err.message);
            });
        }

        function sendMessage() {
            const receiverId = document.getElementById('receiverId').value;
            const receiverPlate = document.getElementById('receiverPlate').value;
            const content = document.getElementById('messageInput').value;

            if (!content) return;
            if (!receiverId && !receiverPlate) return alert("Enter a Receiver ID or Plate Number");

            const payload = {
                senderId: myId,
                content: content
            };

            if (receiverId) payload.receiverId = receiverId;
            if (receiverPlate) payload.receiverPlate = receiverPlate;

            console.log("Sending:", payload);
            socket.emit('send_message', payload);
            
            // Clear input
            document.getElementById('messageInput').value = '';
        }

        function addMessageToUI(text, type, senderName) {
            const list = document.getElementById('messagesList');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `<strong>${senderName}:</strong> ${text}`;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }
    </script>
</body>
</html>
